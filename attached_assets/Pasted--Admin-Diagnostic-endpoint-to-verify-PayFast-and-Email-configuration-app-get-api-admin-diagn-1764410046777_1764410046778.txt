 // Admin: Diagnostic endpoint to verify PayFast and Email configuration
  app.get("/api/admin/diagnostics", isAuthenticated, async (req: any, res: Response) => {
    try {
      const userId = await getUserIdFromToken(req);
      if (!userId) return res.status(401).json({ message: "Unauthorized" });
      const user = await storage.getUser(userId);
      if (!user?.isAdmin) return res.status(403).json({ message: "Admin access required" });

      const diagnostics = {
        timestamp: new Date().toISOString(),
        payfast: {
          merchant_id: process.env.PAYFAST_MERCHANT_ID ? `${process.env.PAYFAST_MERCHANT_ID.substring(0, 4)}****` : 'NOT SET',
          merchant_key: process.env.PAYFAST_MERCHANT_KEY ? '***SET***' : 'NOT SET',
          passphrase: process.env.PAYFAST_PASSPHRASE ? '***SET***' : 'NOT SET',
          mode: process.env.PAYFAST_MODE || 'NOT SET',
          frontend_url: process.env.FRONTEND_URL || 'NOT SET (defaults to timeless.organic)',
          backend_url: process.env.BACKEND_URL || 'NOT SET',
        },
        email: {
          smtp_host: process.env.SMTP_HOST ? `${process.env.SMTP_HOST.substring(0, 10)}...` : 'NOT SET',
          smtp_port: process.env.SMTP_PORT || 'NOT SET',
          smtp_user: process.env.SMTP_USER ? `${process.env.SMTP_USER.substring(0, 5)}...` : 'NOT SET',
          smtp_pass: process.env.SMTP_PASS ? '***SET***' : 'NOT SET',
        },
        urls: {
          return_url: `${process.env.FRONTEND_URL || 'https://www.timeless.organic'}/payment/success`,
          cancel_url: `${process.env.FRONTEND_URL || 'https://www.timeless.organic'}/payment/cancel`,
          notify_url: `${process.env.BACKEND_URL || 'http://localhost:5000'}/api/payment/notify`,
        },
        issues: [] as string[],
      };

      // Check for common issues
      if (!process.env.PAYFAST_MERCHANT_ID) diagnostics.issues.push('PAYFAST_MERCHANT_ID not set');
      if (!process.env.PAYFAST_MERCHANT_KEY) diagnostics.issues.push('PAYFAST_MERCHANT_KEY not set');
      if (!process.env.PAYFAST_PASSPHRASE) diagnostics.issues.push('PAYFAST_PASSPHRASE not set');
      if (process.env.PAYFAST_MODE !== 'production' && process.env.PAYFAST_MODE !== 'live') diagnostics.issues.push('PAYFAST_MODE should be "production" or "live" for onsite payments');
      if (!process.env.SMTP_HOST) diagnostics.issues.push('SMTP_HOST not set - emails will not be sent');
      if (!process.env.SMTP_USER) diagnostics.issues.push('SMTP_USER not set - emails will not be sent');
      if (!process.env.BACKEND_URL) diagnostics.issues.push('BACKEND_URL not set - PayFast notify webhook may fail');